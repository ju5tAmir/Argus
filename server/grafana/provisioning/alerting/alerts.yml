apiVersion: 1

groups:
  - orgId: 1
    name: IoT Alerts
    folder: IoT
    interval: 1m
    rules:
      - uid: instance-down
        title: InstanceDown
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB67CCBA13
            model:
              expr: up{job="rpi-nodes"}
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "RPi node {{ $labels.instance }} is down"
          description: "{{ $labels.instance }} has been unreachable for more than 1 minute."

      - uid: high-cpu
        title: HighCPU
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB67CCBA13
            model:
              expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle",job="rpi-nodes"}[5m])) * 100)
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 90
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU on {{ $labels.instance }}"
          description: "CPU usage on {{ $labels.instance }} has been above 90% for 5 minutes."

      - uid: high-memory
        title: HighMemory
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB67CCBA13
            model:
              expr: (1 - (node_memory_MemAvailable_bytes{job="rpi-nodes"} / node_memory_MemTotal_bytes{job="rpi-nodes"})) * 100
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 85
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage on {{ $labels.instance }} has been above 85% for 5 minutes."

      - uid: disk-almost-full
        title: DiskAlmostFull
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB67CCBA13
            model:
              expr: (1 - (node_filesystem_avail_bytes{job="rpi-nodes",mountpoint="/",fstype!="tmpfs"} / node_filesystem_size_bytes{job="rpi-nodes",mountpoint="/",fstype!="tmpfs"})) * 100
              instant: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 85
                  operator:
                    type: and
                  reducer:
                    type: last
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk almost full on {{ $labels.instance }}"
          description: "Disk usage on {{ $labels.instance }} is above 85%."
